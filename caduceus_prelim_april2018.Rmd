---
title: "CADUCEUS Preliminary Results"
subtitle: "Presentation at Kohler, April 2018"
author: "Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD"
output:
  html_notebook:
    theme: flatly
    highlight: tango
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
---

CADUCEUS is an ancillary study enrolling patients from the MENDS2, MOSAIC, and
INSIGHT studies in progress at Vanderbilt University Medical Center, looking at
three enzyme levels (BChE, AChE, and AChe in hemoglobin) during the course of
critical illness. This preliminary analysis describes study results as of April
2018.

```{r setup, results = "hide"}
knitr::opts_chunk$set(message = FALSE)

suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(forcats))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(glue))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(captioner))
suppressPackageStartupMessages(library(rms))
suppressPackageStartupMessages(library(naniar))
suppressPackageStartupMessages(library(sparkline))

## Hmisc setup for nicely printing summaryM output
mu <- markupSpecs$html

## -- General helper functions (summary stats, formatting/printing) ------------
factor_tf <-
  function(x){ factor(as.numeric(x), levels = 1:0, labels = c("Yes", "No")) }
format_comma <- partial(format, big.mark = ",")
sum_na <- partial(sum, na.rm = TRUE)
q25 <- partial(quantile, probs = 0.25, na.rm = TRUE)
q50 <- partial(quantile, probs = 0.50, na.rm = TRUE)
q75 <- partial(quantile, probs = 0.75, na.rm = TRUE)
mean_na <- partial(mean, na.rm = TRUE)
sd_na <- partial(sd, na.rm = TRUE)
rndformat <- function(x, digits = 2){ format(round(x, digits), nsmall = digits) }
get_npct <- function(num, denom){
  sprintf("%s (%s%%)", num, round((num / denom) * 100))
}
describe_cont <- function(
  v_q50, v_q25, v_q75, v_mean, v_sd, dig_iqr = 0, dig_msd = 2
){
  sprintf(
    "%s [%s, %s]\\\n%s +/- %s",
    rndformat(v_q50, digits = dig_iqr),
    rndformat(v_q25, digits = dig_iqr),
    rndformat(v_q75, digits = dig_iqr),
    rndformat(v_mean, digits = dig_msd),
    rndformat(v_sd, digits = dig_msd)
  )
}

## Wrapper with my preferred options for printing summaryM objects
my_html <- function(sMobj, caption){
  html(
    sMobj,
    exclude1 = FALSE, long = TRUE, digits = 2, what = "%", npct = "both",
    prmsd = TRUE, brmsd = TRUE, middle.bold = TRUE,
    ## These options don't seem to be working.
    msdsize = mu$smaller2, outer.size = mu$smaller2, rowsep = TRUE,
    caption = caption
  )
}

## kable_styling wrapper to ensure all tables are consistently styled
mykablestyle <- function(obj, stripes = FALSE, ...){
  boptions <- c("hover", "responsive", "condensed", "bordered")
  if(stripes){ boptions <- c(boptions, "striped") }
  
  kable_styling(
    obj,
    bootstrap_options = boptions,
    full_width = FALSE,
    ...
  )
}

```

```{r captions, results = "hide"}
## -- Table and figure captions ------------------------------------------------
table_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")

table_nums(name = "descriptives", caption = "Description of CADUCEUS Cohort")

# fig_nums(name = "exclusions", caption = "Study Exclusions")

```

```{r load_data}
## -- Source script that reads in, combines current data from all studies ------
source("combine_data.R")

## -- Restrict cohort to patients, days with >=1 enzyme measurement ------------
daily_df <- filter(
  daily_df,
  !is.na(cad_ache_ul) | !is.na(cad_ache_ughb) | !is.na(cad_bche_ul)
)

# ## What study days have enzymes?
# ggplot(data = daily_df, aes(x = cad_day)) +
#   geom_bar(stat = "count") +
#   labs(
#     x = "Study Day (CADUCEUS Date - Enrollment Date)",
#     y = "Number of Enzyme Measurements"
#   )

## We want to focus on study days 1/3/5/7/14. These study days should have blood
## draws often, per the various study protocols, and thus have the most enzyme
## measurements. Other blood draws occur at the time of hospital discharge,
## which varies per patient and thus is less helpful for our current purposes.

## Due to common data collection happenings, combine day 2 with day 1; 4 with 3;
##  6 with 5
daily_sub <- daily_df %>%
  mutate(
    cad_day = ifelse(cad_day <= 6 & cad_day %% 2 == 0, cad_day - 1, cad_day)
  ) %>%
  filter(cad_day %in% c(seq(1, 7, 2), 14))

## Vector of unique patients with >=1 enzyme measurement
cad_pts <- unique(daily_sub$id)

## -- Add labels to descriptive dataset ----------------------------------------
oneobs_desc <- subset(oneobs_df, id %in% cad_pts)
label(oneobs_desc$age) <- "Age at enrollment"
label(oneobs_desc$gender) <- "Gender"
label(oneobs_desc$days_del) <- "Days with delirium"
label(oneobs_desc$days_coma) <- "Days with coma"
label(oneobs_desc$died_inhosp) <- "In-hospital mortality"

## Dummy variable, because formatting
oneobs_desc$allpts <- "All Patients"

```

# Description of Cohort

We currently have `r length(cad_pts)` patients, enrolled in three studies, with
CADUCEUS enzyme measurements available on at least one of study days 1, 3, 5, 7,
and/or 14.[^1] We focus on these days because the three study protocols require
blood draws at various combinations of those time points, and thus most of our
enzyme levels occur at those time points.[^2]

[^1]: "Study day" = days after enrollment; study day 1 = day of enrollment.
[^2]: Enzyme levels are available at other time points, generally because some
patients also contributed blood levels at hospital discharge, which obviously
varies per individual. Due to these varying timelines and low sample size on any
given day, these are less helpful for our current purposes and are not included.

`r table_nums("descriptives", display = "cite")` provides a basic description of
these patients at study enrollment as well as information on their mental status
throughout the study. **Note** that because our mortality rates among this
critically ill cohort are high, durations of delirium and coma are often
truncated by death.

```{r descriptives}
html(
  summaryM(
    age + gender + days_del + days_coma + died_inhosp ~ allpts,
    data = oneobs_desc
  ),
  long = TRUE,
  exclude1 = FALSE,
  what = "%",
  digits = 2,
  npct = "both",
  caption = "Cohort Baseline and In-Hospital Characteristics",
  insert.bottom = "Note that because data collection is ongoing, hospital mortality status is not yet available on all patients."
)

```

# Description of Enzyme Measures

# Enzymes vs Mental Status
